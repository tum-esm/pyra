---
sidebar_position: 3
sidebar_label: Usage
---

import Abbreviation from '@site/src/components/abbreviation';

# How to use it

## Parts of PYRA

The three parts of PYRA are:

-   **PYRA Core:** Running in the background, looping over all automation steps infinitely in a defined interval.
-   **PYRA CLI:** Command Line Interface (CLI) used to interact with PYRA Core
-   **PYRA UI:** Graphical user Interface (GUI) used to interact with PYRA Core and send PYRA CLI commands

## PYRA Core

For a description of how the core works, please read the [Developer Guide](/docs/category/developer-guide).

## Graphical user Interface (GUI)

The is how the GUI looks. The tab "PLC Controls" only appear when you have configured the [TUM PLC](/docs/user-guide/tum-plc-and-helios).

<img src='/img/docs/overview-tab.png' className='tw-rounded-lg tw-mb-4' />

When changes are made to the `config.json` file directly (not from the GUI), a popup will appear, telling you to reload the window:

<img src='/img/docs/config-file-reload.png' className='tw-rounded-lg tw-mb-4' />

:::note

We are currently experiencing a Bug on some systems that the "config has changed, reload required" popup shows up when changes were made through the GUI. Also, the popup appears multiple times. This should be resolved in the future.

The issue progress can be tracked here: https://github.com/tum-esm/pyra/issues/106

:::

## Logs

PYRA will store all of its activity in log files. The files `info.log` and `debug.log` will only contain logs from the past hour. Older log lines will be archived periodically to keep the main log files easy to parse.

```
üìÅ <DOCUMENTS DIR>
    üìÅ pyra
        üìÅ pyra-x.y.z
            üìÅ logs
                üìÑ info.log
                üìÑ debug.log
                üìÅ archive
                    üìÑ YYYYMMDD-info.log
                    üìÑ YYYYMMDD-debug.log
                    üìÑ ...
```

Inside the logs tab the content from the log files will be fetched every 10 seconds. The debug level includes more information. The log-fetching can be paused (on the "live" button) for analyzing logs in detail. There is a button that opens the `pyra/pyra-x.y.z/logs` folder in the file explorer.

<img src='/img/docs/logs-tab.png' className='tw-rounded-lg tw-mb-4' />

## Measurement Modes and Triggers

The **"measurement decision"** (whether measurements should run or not) depends on the **"measurement mode"**:

-   **Automatic mode:** Measurement decision is made based on defined triggers (see below)
-   **Manual mode:** A start/stop button for manual control
-   **CLI mode:** The config contains a field, where the CLI can add a decision result

:::tip

You can use CLI mode when you already have build a system that evaluates measurements conditions and want to use PYRA for the rest of the operation. Respective CLI commands can be found in the [next section](#command-line-interface-cli).

:::

In the automation tab, PYRA's measurement mode can be selected.

<img src='/img/docs/measurement-modes.png' className='tw-rounded-lg tw-mb-4' />

In the configuration tab you can select measurement triggers that should be considered in automatic mode

<img src='/img/docs/triggers-config.png' className='tw-rounded-lg tw-mb-4' />

:::note

**"Helios"** is our own module to determine whether direct sunlight (required by the EM27/SUN) is present or not. Read about it [here](/docs/user-guide/tum-plc-and-helios).

:::

## Command Line Interface (CLI)

### Help Menu

Top level help menu:

```bash
pyra-cli --help
# Usage: pyra-cli [OPTIONS] COMMAND [ARGS]...
#
# Options:
#   --help  Show this message and exit.
#
# Commands:
#   config
#   core
#   logs
#   plc
#   remove-filelocks  Remove all filelocks.
#   state
```

Help menu of individual command groups:

```bash
pyra-cli config --help
# Usage: pyra-cli config [OPTIONS] COMMAND [ARGS]...
#
# Options:
#   --help  Show this message and exit.
#
# Commands:
#   get       Read the current config.json file.
#   update    Set the config.json file.
#   validate  Validate the current config.json file.
```

Help menu of individual commands:

```bash
pyra-cli config update --help
# Usage: pyra-cli config update [OPTIONS] [CONTENT]
#
#   Set config. Pass the JSON directly or via a file path. Only a subset of the
#   required config variables has to be passed. The non-occuring values will be
#   reused from the current config.
#
#   The required schema can be found in the documentation.
#
# Options:
#   --help  Show this message and exit.
```

### Config Update

Running `pyra-cli config update "{\"general\":{\"seconds_per_core_interval\": 20}}"` will update the number of seconds pyra spends in one loop. The same command can be achieved in Python without all the escaping done manually:

```python
import json
import os

update = {
    "seconds_per_core_interval": 20
}

cli_command = f"pyra-cli config update {json.dumps(update)}"
```

PYRA will validate the structure of the update and enforce some rules on the parameter values (value range, file exists, etc.)

<img
    src='/img/docs/cli-config-update-example.png'
    className='tw-rounded tw-mb-4'
/>

### Config Validation Rules

The expected schema (used in `/packages/ui/src/custom-types.ts`):

```typescript
export type config = {
    general: {
        seconds_per_core_interval: number;
        test_mode: boolean;
        station_id: string;
        min_sun_elevation: number;
    };
    opus: {
        em27_ip: string;
        executable_path: string;
        experiment_path: string;
        macro_path: string;
        username: string;
        password: string;
    };
    camtracker: {
        config_path: string;
        executable_path: string;
        learn_az_elev_path: string;
        sun_intensity_path: string;
        motor_offset_threshold: number;
    };
    error_email: {
        sender_address: string;
        sender_password: string;
        notify_recipients: boolean;
        recipients: string;
    };
    measurement_decision: {
        mode: 'automatic' | 'manual' | 'cli';
        manual_decision_result: boolean;
        cli_decision_result: boolean;
    };
    measurement_triggers: {
        consider_time: boolean;
        consider_sun_elevation: boolean;
        consider_helios: boolean;
        start_time: { hour: number; minute: number; second: number };
        stop_time: { hour: number; minute: number; second: number };
        min_sun_elevation: number;
    };
    tum_plc: null | {
        ip: string;
        version: number;
        controlled_by_user: boolean;
    };
    helios: null | {
        camera_id: number;
        evaluation_size: number;
        seconds_per_interval: number;
        measurement_threshold: number;
        edge_detection_threshold: number;
        save_images: boolean;
    };
    upload: null | {
        host: string;
        user: string;
        password: string;
        upload_ifgs: boolean;
        src_directory_ifgs: string;
        dst_directory_ifgs: string;
        remove_src_ifgs_after_upload: boolean;
        upload_helios: boolean;
        dst_directory_helios: string;
        remove_src_helios_after_upload: boolean;
    };
};
```

The value rules to be validated (used in `/packages/core/types/config.py`):

```python
assertions: list[Callable[[], None]] = [
    lambda: assert_min_max("general.seconds_per_core_interval", 5, 600),
    lambda: assert_min_max("general.min_sun_elevation", 0, 90),
    lambda: assert_ip_address("opus.em27_ip"),
    lambda: assert_file_path("opus.executable_path"),
    lambda: assert_file_path("opus.experiment_path"),
    lambda: assert_file_path("opus.macro_path"),
    lambda: assert_file_path("camtracker.config_path"),
    lambda: assert_file_path("camtracker.executable_path"),
    lambda: assert_file_path("camtracker.learn_az_elev_path"),
    lambda: assert_file_path("camtracker.sun_intensity_path"),
    lambda: assert_min_max("camtracker.motor_offset_threshold", -360, 360),
    lambda: assert_min_max("measurement_triggers.min_sun_elevation", 0, 90),
    lambda: assert_min_max("measurement_triggers.start_time.hour", 0, 23),
    lambda: assert_min_max("measurement_triggers.stop_time.hour", 0, 23),
    lambda: assert_min_max("measurement_triggers.start_time.minute", 0, 59),
    lambda: assert_min_max("measurement_triggers.stop_time.minute", 0, 59),
    lambda: assert_min_max("measurement_triggers.start_time.second", 0, 59),
    lambda: assert_min_max("measurement_triggers.stop_time.second", 0, 59),
    lambda: assert_ip_address("tum_plc.ip"),
    lambda: assert_min_max("helios.camera_id", 0, 999999),
    lambda: assert_min_max("helios.evaluation_size", 1, 100),
    lambda: assert_min_max("helios.seconds_per_interval", 5, 600),
    lambda: assert_min_max("helios.measurement_threshold", 0.1, 1),
    lambda: assert_ip_address("upload.host"),
]
```

:::info

With `pyra-cli config get` only the schema will be validated, not the value rules. This is because the GUI can deal with invalid values but not with an invalid schema.

:::

## Error Emails

Whenever PYRA encounters any errors, it sends out emails to a list of recipients. An "error resolved" email helps with self-resolving issues and team-communication - so that others get notified when one person fixed the problem.

**When errors occur:**

<img
    src='/img/docs/email-error-occured.png'
    className='tw-rounded-lg tw-mb-4'
/>

**When errors are resolved:**

<img
    src='/img/docs/email-errors-resolved.png'
    className='tw-rounded-lg tw-mb-4'
/>

:::note

The "CoverError" comes from the TUM <Abbreviation short="PLC"/> Module controlling our weather protection enclosure.

:::
