name: 'build-on-prerelease'
on:
    push:
        branches:
            - prerelease

defaults:
    run:
        working-directory: packages/ui

jobs:
    publish-tauri:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v2

            - name: Set up NodeJS with Yarn
              uses: actions/setup-node@v3
              with:
                  node-version: 16
                  cache: 'yarn'
                  cache-dependency-path: packages/ui/yarn.lock

            - name: install Rust stable
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable

            # load cached tauri stuff
            - name: Load cached tauri stuff
              id: cached-poetry-dependencies
              uses: actions/cache@v3
              with:
                  path: packages/ui/src-tauri/target
                  key: tauri-stuff-${{ runner.os }}

            - name: install app dependencies and build it
              run: |
                  yarn install --frozen-lockfile
                  yarn build

            - uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: v__VERSION__-prerelease
                  releaseName: 'v__VERSION__-prerelease (generated by CI)'
                  releaseBody: 'TODO: description'
                  releaseDraft: true
                  prerelease: true
