---
sidebar_position: 4
sidebar_label: Upload
---

# The Upload Process

## Interferograms Directory Structure

We have set up our OPUS macro files to produce a directory structure like this:

```
ğŸ“ <IFG OUTPOUT DIR>
    ğŸ“ YYYYMMDD
        ğŸ“„ stationid-YYYYMMDD.0001
        ğŸ“„ stationid-YYYYMMDD.0002
        ğŸ“„ ...
    ğŸ“ YYYYMMDD
        ğŸ“„ stationid-YYYYMMDD.0001
        ğŸ“„ stationid-YYYYMMDD.0002
        ğŸ“„ ...
```

:::note

When using [Helios](/docs/user-guide/tum-plc-and-helios), saved images will be stored inside `/logs/helios/` in the same directory structure as the interferograms output directory. This is why the upload can be used for both types of data.

We will expand this to be useable for an arbitrary number of directories in the future: See [GitHub](https://github.com/tum-esm/pyra/issues?q=is%3Aissue+is%3Aopen+label%3A%22Update%3A+Upload+Improvements%22).

:::

## How the Upload works

We are using the python library [fabric](https://www.fabfile.org/) that supplies a high-level API for SSH clients.

The upload uses an `upload-meta.json` file in each `YYYYMMDD` directory to save the upload state.

```json
{
    "complete": false,
    "fileList": ["file 1", "file 2", "..."],
    "createdTime": 0,
    "lastModifiedTime": 0
}
```

**Upload steps:**

1. Create an empty `upload-meta.json` for new upload processes and upload it to the server
2. Download the `upload-meta.json` from the server if upload has been started before but interrupted
3. When files are found in the `fileList` that do not exist locally: <span className="tw-bg-red-200 tw-text-red-900 tw-rounded tw-px-1 tw-font-semibold tw-py-0.5 -tw-my-0.5">raise an exception</span>
4. When the remote meta says `complete=True` but there are local files not in `fileList`: <span className="tw-bg-red-200 tw-text-red-900 tw-rounded tw-px-1 tw-font-semibold tw-py-0.5 -tw-my-0.5">raise an exception</span>
5. For every file that is found locally but not in the server side meta, upload it with `scp`
6. Every 25 files - for performance reasons - update the server-side meta-file
7. Upload the file `/scripts/get_upload_dir_checksum.py` to the server and calculate the checksum of the `YYYYMMDD` directory that is on the server (based on `fileList`).
8. Calculate the local checksum using the same script
9. When both checksums match, set `complete=True` in the remote meta and possibly remove the local `YYYYMMDD` directory

## Causes for an `InvalidUploadState` exception

Whenever the upload encounters an invalid state, it raises an `InvalidUploadState` exception, which appears in the logs, and continues with the next `YYYYMMDD` directory. Possible causes are:

-   The upload thread crashed during the removal of the local `YYYYMMDD` directory
-   Files to the local `YYYYMMDD` directory were added after that day
-   Files from the local `YYYYMMDD` directory were removed manually
-   The remote meta file was manipulated by hand

The idea of the `complete=true` flag is that the post-processing should only consider data where the upload is complete.

## Measures to ensure upload integrity

1. The local files will only be deleted when the checksums of the local and remote directory are equal: Every missing, additional or modified file in the `fileList` will change the checksum.

2. The `complete=true` flag will also only be set, when the checksums match.

3. There is a test script that generates a bunch of sample directories and sample files, runs the upload, and checks the final upload state. See [/docs/developer-guide/testing-and-ci](/docs/developer-guide/testing-and-ci).
